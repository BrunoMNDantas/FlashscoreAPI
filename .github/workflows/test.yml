name: Test Production

on:
  schedule:
    - cron: '0 6 * * *'

jobs:
  notify_start:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Set Execution Permissions
        run: chmod +x ./deploy/scripts/*.sh
      - name: Notify start
        run: ./deploy/scripts/notify.sh
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          MESSAGE: "üìà Starting daily test to Production"
          TWILIO_WHATSAPP_NUMBER: ${{ secrets.TWILIO_WHATSAPP_NUMBER }}
          TWILIO_NOTIFY_NUMBER: ${{ secrets.TWILIO_NOTIFY_NUMBER }}

  test_production:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Node.js (For Newman)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Newman (Postman CLI)
        run: npm install -g newman

      - name: Run Contract Tests on Production
        run: |
          newman run ./deploy/postman/contract_tests.postman_collection.json \
          -e ./deploy/postman/contract_tests.postman_environment.json \
          --env-var 'env-apiKey=${{ secrets.POSTMAN_API_KEY }}' \
          --env-var 'env-serverL=${{ secrets.PRODUCTION_SERVER_URL }}' \
          --env-var 'env-schemaUrl=${{ secrets.PRODUCTION_SCHEMA_URL }}' \
          --reporters cli,junit \
          --reporter-junit-export results.xml

      - name: Run API Tests on Production
        run: |
          newman run ./deploy/postman/api_tests.postman_collection.json \
          -e ./deploy/postman/api_tests.postman_environment.json \
          --env-var 'baseUrl=${{ secrets.PRODUCTION_SERVER_URL }}' \
          --reporters cli,junit \
          --reporter-junit-export results.xml

  notify_end:
    needs: [test_production]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Set Execution Permissions
        run: chmod +x ./deploy/scripts/*.sh
      - name: Notify completion
        run: ./deploy/scripts/notify.sh
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          MESSAGE: "${{ needs.test_production.result == 'success' && '‚úÖ Production tests passed!' || '‚ùå Production tests failed!' }}"
          TWILIO_WHATSAPP_NUMBER: ${{ secrets.TWILIO_WHATSAPP_NUMBER }}
          TWILIO_NOTIFY_NUMBER: ${{ secrets.TWILIO_NOTIFY_NUMBER }}